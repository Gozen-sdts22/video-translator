# 動画字幕生成ツール - 全体要件定義書

## 1. プロジェクト概要

### 1.1 目的
動画ファイルから日本語字幕を自動生成し、中国語に翻訳するツールを開発する。
生成した字幕はAegisubで編集可能なASS形式で出力する。

### 1.2 背景
- アイドル系コンテンツの字幕作成を効率化したい
- 日本語→中国語の翻訳作業を自動化したい
- 話者が複数いる場合に区別できるようにしたい

### 1.3 ターゲットユーザー
- アイドルコンテンツの翻訳者
- 字幕作成者

---

## 2. システム要件

### 2.1 機能要件

| ID | 機能 | 説明 | 優先度 |
|----|------|------|--------|
| F-001 | 動画読み込み | MP4等の動画ファイルを入力として受け付ける | 必須 |
| F-002 | 音声抽出 | 動画から音声トラックを抽出する（FFmpeg使用） | 必須 |
| F-003 | 文字起こし | 音声を日本語テキストに変換する（タイムスタンプ付き） | 必須 |
| F-004 | 話者識別 | 最大4人の話者を識別し、IDを付与する | 必須 |
| F-005 | 翻訳 | 日本語テキストを中国語に翻訳する | 必須 |
| F-006 | 品質チェック | AIによる誤認識・翻訳品質のチェックと修正提案 | 必須 |
| F-007 | 人間レビュー | WebUI上で修正提案を確認・編集できる | 必須 |
| F-008 | カスタム辞書 | 誤認識パターンの登録・管理・自動適用 | 必須 |
| F-009 | 字幕出力 | ASS形式で出力（話者ごとに色分け、日中両方表示） | 必須 |
| F-010 | WebUI | ファイルアップロード、進捗表示、レビュー画面を提供 | 必須 |

### 2.2 非機能要件

| ID | 項目 | 要件 |
|----|------|------|
| NF-001 | 精度 | 精度優先（処理速度より品質を重視） |
| NF-002 | 動画長さ | 数十分の動画に対応 |
| NF-003 | 話者数 | 最大4人まで |
| NF-004 | 実行環境 | ローカル環境（GPU搭載PC） |
| NF-005 | 言語 | 入力：日本語音声、出力：日本語＋中国語字幕 |

### 2.3 制約条件

- ローカル実行（インターネット接続はAPI呼び出し時のみ必要）
- NVIDIA GPU必要（Whisper、pyannote用）
- Claude APIキー必要
- HuggingFaceトークン必要（pyannote用）

---

## 3. システムアーキテクチャ

### 3.1 全体フロー

```
┌─────────────────────────────────────────────────────────────┐
│                     WebUI (Gradio)                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                  │
│  │アップロード│  │ レビュー │  │辞書管理  │                  │
│  └──────────┘  └──────────┘  └──────────┘                  │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    処理パイプライン                          │
│                                                             │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐    │
│  │音声抽出 │ → │文字起こし│ → │辞書適用 │ → │  翻訳   │    │
│  │(FFmpeg) │   │(Whisper)│   │         │   │(Claude) │    │
│  └─────────┘   └─────────┘   └─────────┘   └─────────┘    │
│                     │                            │          │
│                     ▼                            ▼          │
│               ┌─────────┐                 ┌─────────┐       │
│               │話者識別 │                 │品質チェック│      │
│               │(pyannote)│                │(Claude) │       │
│               └─────────┘                 └─────────┘       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      出力                                    │
│                   subtitle.ass                               │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 技術スタック

| コンポーネント | 技術 | バージョン（推奨） |
|---------------|------|-------------------|
| WebUI | Gradio | 4.x |
| 音声抽出 | FFmpeg | 6.x |
| 音声認識 | Faster-Whisper | 1.x |
| 話者識別 | pyannote-audio | 3.x |
| 翻訳・チェック | Claude API | claude-sonnet-4-20250514 |
| 言語 | Python | 3.10+ |

### 3.3 ファイル構成

```
subtitle-generator/
├── app.py                    # Gradio WebUI メイン
├── config.py                 # 設定管理
├── requirements.txt          # 依存パッケージ
│
├── core/                     # コア処理モジュール
│   ├── __init__.py
│   ├── audio_extractor.py    # FFmpeg音声抽出
│   ├── transcriber.py        # Faster-Whisper文字起こし
│   ├── diarizer.py           # pyannote話者識別
│   ├── translator.py         # Claude API翻訳
│   └── checker.py            # Claude API品質チェック
│
├── models/                   # データモデル
│   ├── __init__.py
│   ├── segment.py            # 字幕セグメント
│   └── dictionary.py         # カスタム辞書
│
├── utils/                    # ユーティリティ
│   ├── __init__.py
│   ├── ass_generator.py      # ASS出力
│   ├── time_utils.py         # 時間変換
│   └── text_utils.py         # テキスト処理
│
├── data/                     # データ保存
│   ├── dictionary.json       # カスタム辞書
│   └── temp/                 # 一時ファイル
│
└── tests/                    # テスト
    ├── __init__.py
    ├── test_transcriber.py
    └── test_translator.py
```

---

## 4. データ設計

### 4.1 字幕セグメント

```python
@dataclass
class Segment:
    id: int                   # セグメントID
    start: float              # 開始時間（秒）
    end: float                # 終了時間（秒）
    speaker: str              # 話者ID（例: "SPEAKER_00"）
    text_ja: str              # 日本語テキスト
    text_zh: str              # 中国語テキスト
    status: str               # "ok" | "warning" | "error"
    suggestions: List[Suggestion]  # 修正提案リスト
```

### 4.2 修正提案

```python
@dataclass
class Suggestion:
    type: str                 # "recognition" | "translation" | "consistency"
    field: str                # "text_ja" | "text_zh"
    original: str             # 元の値
    suggested: str            # 提案値
    reason: str               # 理由
    add_to_dict: bool         # 辞書追加候補フラグ
```

### 4.3 カスタム辞書エントリ

```python
@dataclass
class DictionaryEntry:
    id: int                   # エントリID
    wrong: str                # 誤認識パターン
    correct: str              # 正しい表記
    category: str             # カテゴリ（例: "アイドル用語"）
    created_at: datetime      # 作成日時
    used_count: int           # 使用回数
```

### 4.4 辞書ファイル形式（JSON）

```json
{
  "entries": [
    {
      "id": 1,
      "wrong": "おしめん",
      "correct": "推しメン",
      "category": "アイドル用語",
      "created_at": "2024-01-01T00:00:00Z",
      "used_count": 5
    }
  ],
  "pending_suggestions": [
    {
      "wrong": "えーけーびー",
      "correct": "AKB",
      "occurrences": 3
    }
  ]
}
```

---

## 5. 外部インターフェース

### 5.1 入力

| 項目 | 形式 | 説明 |
|------|------|------|
| 動画ファイル | MP4, MKV, AVI等 | FFmpegが対応する形式 |
| カスタム辞書 | JSON | インポート用（オプション） |

### 5.2 出力

| 項目 | 形式 | 説明 |
|------|------|------|
| 字幕ファイル | ASS | Aegisub互換、話者色分け対応 |
| カスタム辞書 | JSON | エクスポート用 |

### 5.3 外部API

| API | 用途 | 認証 |
|-----|------|------|
| Claude API | 翻訳、品質チェック | APIキー |
| HuggingFace | pyannoteモデルダウンロード | トークン |

---

## 6. 画面設計

### 6.1 タブ構成

1. **アップロードタブ**: 動画ファイルのアップロードと処理実行
2. **レビュータブ**: 字幕の確認・編集、修正提案の適用
3. **辞書管理タブ**: カスタム辞書の管理

### 6.2 アップロードタブ

- ファイルドロップエリア
- オプション設定（話者識別ON/OFF等）
- 処理開始ボタン
- 進捗表示

### 6.3 レビュータブ

- セグメント一覧（フィルタ・検索機能付き）
- 各セグメントの編集フォーム
- 修正提案の表示と適用ボタン
- 辞書追加ボタン
- ASSダウンロードボタン

### 6.4 辞書管理タブ

- 辞書エントリ一覧
- 新規追加フォーム
- インポート/エクスポートボタン
- 学習候補（チェックAgentが検出した新語）

---

## 7. 開発フェーズ

| フェーズ | 内容 | 成果物 |
|---------|------|--------|
| Phase 1 | コア機能実装 | 音声抽出→文字起こし→翻訳→ASS出力の基本パイプライン |
| Phase 2 | チェックAgent追加 | 品質チェック機能、修正提案生成 |
| Phase 3 | WebUI（レビュー画面） | Gradioベースの3タブ構成UI |
| Phase 4 | 辞書管理機能 | カスタム辞書のCRUD、学習候補管理 |

---

## 8. 用語定義

| 用語 | 説明 |
|------|------|
| セグメント | 1つの字幕単位（開始時間、終了時間、テキストを含む） |
| 話者識別（ダイアライゼーション） | 音声から誰が話しているかを特定する処理 |
| ASS形式 | Advanced SubStation Alpha、字幕ファイル形式 |
| Aegisub | 字幕編集ソフトウェア |
| カスタム辞書 | 誤認識パターンと正しい表記のマッピング |

---

## 9. 関連ドキュメント

- `01_Phase1_コア機能_要件定義書.md`
- `02_Phase2_チェックAgent_要件定義書.md`
- `03_Phase3_WebUI_要件定義書.md`
- `04_Phase4_辞書管理_要件定義書.md`
